---
title: "Workshop Group 31/1 Project"
output: html_document
author: "Ryan Hall, Eddie Washbrook, Eric Rogers, Chenyi He, (add name here)"
date: "2022-11-16"
---
# Do geographical location and characteristics have an effect on internet quality of life in the UK? An analysis of and comparison between two months in 2019

### Load required packages

```{r load-packages, message = FALSE, warning = FALSE}
library(tidyverse)
library(tidymodels)
library(janitor)
library(geojsonio)
library(ggplot2)
```

### Read in data from csv files

```{r load-data, message = FALSE}

feb_2019 <- read.csv("data/broadband_data_february_2019.csv")
aug_2019 <- read.csv("data/broadband_data_august_2019.csv")
gdhi_region <- read.csv("data/gdhi_per_region.csv", skip = 1)

```

### Tidy the datasets to make them easier to use

```{r clean-data}
feb_2019 <- feb_2019 %>%
  clean_names() %>%
  select(-ofcom_product) %>%    # These steps are to make the columns match the August dataset.
  rename("distance_from_exchange" = "distance_from_exchange_band")
  
aug_2019 <- aug_2019 %>%
  clean_names()

regions <- c("United Kingdom", "England", "North East", "North West", "Yorkshire & Humber", "East Midlands", 
             "West Midlands", "East", "London", "South East", "South West", "Wales", "Scotland", "Northern Ireland")

gdhi_region <- gdhi_region %>%
  clean_names() %>%
  drop_na() %>%
  rename("region" = "countries_and_regions_of_the_uk") %>%
  mutate(region = regions,
         gdhi_per_head = str_remove_all(gdhi_per_head, ","),
         gdhi_per_head = as.numeric(gdhi_per_head)
         )

aug_2019_month <- aug_2019 %>%
  mutate(month = "August")

all_2019 <- feb_2019 %>%
  mutate(month = "February") %>%
  rbind(aug_2019_month)

# Join datasets with gdhi_region set
feb_gdhi_join <- left_join(feb_2019, gdhi_region , by = "region")
aug_gdhi_join <- left_join(aug_2019, gdhi_region , by = "region")
all_gdhi_join <- left_join(all_2019, gdhi_region , by = "region")

```

```{r maps, fig.height = 5, fig.width = 3.5}

region_map <- geojson_read("uk_regions.geojson", what = "sp")

ggplot() +
  geom_polygon(data = region_map, aes(x = long, y = lat, group = group), 
               fill = "white", colour = "grey", fig.width = 2) 

avgs <- all_2019 %>%
  group_by(region, month) %>%
  summarise(mean_24hr = mean(x24_hr_average_download_speed))

```

### Household Income vs 24 hour Download Speed - Feb
```{r income-24h_download}
feb_24h_ads_gdhi_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(x24_hr_average_download_speed ~ gdhi_per_head, data = feb_gdhi_join) %>%
  tidy()
feb_24h_ads_gdhi_fit
```


### residuals plot(Household Income vs 24 hour Download Speed - Feb)
```{r residuals_plot_income-24h_download}
feb_24h_ads_gdhi_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(x24_hr_average_download_speed ~ gdhi_per_head, data = feb_gdhi_join)
feb_24h_ads_gdhi_fit_aug  <- augment(feb_24h_ads_gdhi_fit$fit)

ggplot(feb_24h_ads_gdhi_fit_aug, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted x24_hr_average_download_speed", y = "Residuals")
```


### Urban/Rural vs 24 hour Download Speed - Feb
```{r urbanrural-24h_download}
feb_24h_ads_ur_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(x24_hr_average_download_speed ~ urban_rural, data = feb_gdhi_join) %>%
  tidy()
feb_24h_ads_ur_fit
```

### residuals plot(Urban/Rural vs 24 hour Download Speed - Feb)
```{r residuals_urbanrural-24h_download}
feb_24h_ads_ur_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(x24_hr_average_download_speed ~ urban_rural, data = feb_gdhi_join)
feb_24h_ads_ur_fit_aug  <- augment(feb_24h_ads_ur_fit$fit)

ggplot(feb_24h_ads_ur_fit_aug, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted x24_hr_average_download_speed", y = "Residuals")
```




### Main Data Analysis - Set Seed and Split - Both Months
```{r setseed-split}
set.seed(1234)
all_gdhi_join_split <- initial_split(all_gdhi_join)
all_gdhi_join_train <- training(all_gdhi_join_split)
all_gdhi_join_test <- testing(all_gdhi_join_split)
```

### Urban/Rual and GDHI vs 24 hour Download Speed - Model setup
```{r variables effect 24h-download }
all_gdhi_join_train_rec <- recipe(x24_hr_average_download_speed ~ urban_rural + gdhi_per_head, data = all_gdhi_join_train) %>%
 step_dummy(all_nominal(), -all_outcomes()) 

all_gdhi_join_train_mod <- linear_reg() %>%
 set_engine('lm')

all_gdhi_join_train_wflow <- workflow() %>% 
 add_model(all_gdhi_join_train_mod) %>% 
 add_recipe(all_gdhi_join_train_rec)

all_gdhi_join_train_fit <- all_gdhi_join_train_wflow %>% 
 fit(data = all_gdhi_join_train)

```

### Predictions from Model Above
```{r predictions_1}
all_2019_24h_ads_predict <- predict(all_gdhi_join_train_fit, new_data = all_gdhi_join_test) %>%
  bind_cols(all_gdhi_join_test %>% select(x24_hr_average_download_speed, urban_rural, gdhi_per_head))
all_2019_24h_ads_predict
```